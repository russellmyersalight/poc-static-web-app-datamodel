<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Ticket Prediction Playground</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; margin-top: 2em; background-color: #f8f9fa; }
    .thinking-icon { font-size: 2rem; animation: pulse 1s infinite ease-in-out; margin-top: 10px; text-align: center; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
    img.pulsate { width: 100px; animation: pulse 2s infinite; }
  </style>
</head>
<body>
<div class="container">
  <div class="text-center mb-4">
    <h1 class="display-5">AI Ticket Classification Playground</h1>
    <small class="text-muted" id="app-version">Version ...</small>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="ticketTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single" type="button" role="tab">Single Ticket</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk" type="button" role="tab">Bulk Ticket</button>
    </li>
  </ul>

  <div class="tab-content mt-4">
    <!-- Single Ticket Prediction Tab -->
    <div class="tab-pane fade show active" id="single" role="tabpanel">
      <div class="card shadow-sm p-4 mb-4">
        <h4>Single Ticket Classification</h4>
        <form id="ticketForm">
          <div class="mb-3">
            <label for="shortDesc" class="form-label">Short Description</label>
            <input type="text" class="form-control" id="shortDesc" placeholder="Enter short description" required>
          </div>
          <div class="mb-3">
            <label for="longDesc" class="form-label">Long Description</label>
            <textarea class="form-control" id="longDesc" rows="5" placeholder="Enter long description" required></textarea>
          </div>
          <div class="text-center">
            <img id="myImage" class="pulsate d-none" src="img/Designer.png" alt="Pulsating Image">
          </div>
          <div class="text-center mt-3">
            <button type="button" class="btn btn-primary btn-lg" onclick="submitTicket()">Submit</button>
          </div>
        </form>
      </div>

      <!-- Prediction Result -->
      <div class="card shadow-sm p-4 mt-4 d-none" id="result">
        <h2 class="mb-4">Predictions</h2>
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <tbody>
              <tr><th>Service Tower</th><td class="text-primary" id="tower"></td></tr>
              <tr><th>Intent</th><td class="text-primary" id="intent"></td></tr>
              <tr><th>Intent Description</th><td class="text-primary" id="intent-description"></td></tr>
              <tr><th>Summary</th><td id="summary"></td></tr>
              <tr><th>Proposed Solution</th><td id="solution"></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Bulk Ticket Prediction Tab -->
    <div class="tab-pane fade" id="bulk" role="tabpanel">
      <div class="card shadow-sm p-4 mb-4">
        <h4>Bulk Ticket Classification (via CSV)</h4>
        <p class="text-muted">Upload a CSV file with columns: <strong>ticket_id, short_description, long_description</strong></p>
        <div class="mb-3">
          <input type="file" class="form-control" id="csvFileInput" accept=".csv">
        </div>
        <div class="text-center mb-3">
          <button class="btn btn-success" onclick="processCSV()">Upload & Predict</button>
        </div>
        <div id="bulkStatus"></div>
        <div class="text-center mt-3">
          <button id="downloadCsvBtn" class="btn btn-secondary d-none" onclick="downloadCSV()">Download Results</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let latestTimeTaken = null;
const API_ENDPOINT = 'https://func-t-weu-assistant-genai-02.azurewebsites.net/api/predict'; //TSTNF
// const API_ENDPOINT = 'https://func-q-weu-assistant-genai-01.azurewebsites.net/api/predict';  //QAS
let API_ENDPOINT_EXTRA = "==wVJdxVuFzAhfB2NheeVI903ZX9JVWhnACD7U1LUnL4NZHB0Tqce7pE=edoc?".split('').reverse().join('');  //TSTNF
// let API_ENDPOINT_EXTRA = "==QBiZRCuFzA5JO_TzGtA1cXbwYYvs9Tjcvw4fTj2gElJCTysc4V7NLm=edoc?".split('').reverse().join(''); // QAS


async function submitTicket() {
  const loader = document.getElementById('myImage');
  const resultBox = document.getElementById('result');
  loader.classList.remove('d-none');
  resultBox.classList.add('d-none');

  const shortDesc = document.getElementById('shortDesc').value;
  const longDesc = document.getElementById('longDesc').value;

  try {
    const response = await fetch(API_ENDPOINT + API_ENDPOINT_EXTRA, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ shortDescription: shortDesc, description: longDesc })
    });
    const data = await response.json();

    document.getElementById('tower').textContent = data.result.predictedServiceTower;
    document.getElementById('intent').textContent = data.result.predictedIntent;
    document.getElementById('intent-description').textContent = data.result.predictedIntentDescription;
    document.getElementById('solution').textContent = data.result.proposedSolution;
    document.getElementById('summary').textContent = data.result.summary;

    loader.classList.add('d-none');
    resultBox.classList.remove('d-none');
  } catch (error) {
    console.error('Error fetching prediction:', error);
    loader.classList.add('d-none');
    alert("An error occurred. Please try again.");
  }
}

/* ===== CSV UPLOAD & PARALLEL BULK PREDICTION WITH PROGRESS BAR ===== */
let bulkResults = [];
const CONCURRENCY_LIMIT = 1;

async function processCSV() {
  const fileInput = document.getElementById('csvFileInput');
  const statusDiv = document.getElementById('bulkStatus');
  const downloadBtn = document.getElementById('downloadCsvBtn');
  bulkResults = [];
  downloadBtn.classList.add('d-none');
  statusDiv.innerHTML = '';

  if (!fileInput.files.length) {
    alert('Please select a CSV file first.');
    return;
  }

  const file = fileInput.files[0];
  const text = await file.text();
  const rows = text.trim().split(/\r?\n/);
  const headers = rows[0].split(',').map(h => h.trim().toLowerCase());
  const idIndex = headers.indexOf('ticket_id');
  const shortIndex = headers.indexOf('short_description');
  const longIndex = headers.indexOf('long_description');

  if (idIndex === -1 || shortIndex === -1 || longIndex === -1) {
    alert("CSV must include headers: ticket_id, short_description, long_description");
    return;
  }

  const tickets = rows.slice(1).map(line => {
    const cols = line.split(',');
    return {
      id: cols[idIndex]?.trim(),
      shortDescription: cols[shortIndex]?.trim(),
      description: cols[longIndex]?.trim()
    };
  }).filter(t => t.shortDescription && t.description);

  const total = tickets.length;
  let completed = 0;
  let startTime = Date.now();

  // Progress UI
  statusDiv.innerHTML = `
    <div class="mb-2 text-info">Processing ${total} tickets (concurrency: ${CONCURRENCY_LIMIT})...</div>
    <div class="progress" style="height: 25px;">
      <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
           role="progressbar" style="width: 0%">0%</div>
    </div>
    <div class="mt-2 small text-muted" id="progressText"></div>
  `;

  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');

  const updateProgress = () => {
    const percent = Math.round((completed / total) * 100);
    const elapsed = (Date.now() - startTime) / 1000;
    const avgPerTicket = elapsed / (completed || 1);
    const remaining = total - completed;
    const eta = avgPerTicket * remaining;
    const etaFormatted = eta < 5 ? `${eta.toFixed(1)}s` :
                         eta < 60 ? `${Math.round(eta)}s` :
                         `${Math.round(eta / 60)}m ${Math.round(eta % 60)}s`;

    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';
    progressText.innerHTML = `Processed ${completed}/${total} (${percent}%) — ETA: ${etaFormatted}`;
  };

  async function processBatch(startIndex) {
    const ticket = tickets[startIndex];
    if (!ticket) return;

    try {
      const response = await fetch(API_ENDPOINT + API_ENDPOINT_EXTRA, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(ticket)
      });
      const data = await response.json();
      bulkResults[startIndex] = {
        ticket_id: ticket.id,
        short_description: ticket.shortDescription,
        long_description: ticket.description,
        service_tower: data.result.predictedServiceTower || '',
        intent: data.result.predictedIntent || '',
        intent_description: data.result.predictedIntentDescription || '',
        proposed_solution: data.result.proposedSolution || '',
        summary: data.result.summary || ''
      };
    } catch (err) {
      console.error(`Error on ticket ${ticket.id}:`, err);
      bulkResults[startIndex] = {
        ...ticket,
        service_tower: 'Error',
        intent: 'Error',
        intent_description: '',
        proposed_solution: '',
        summary: ''
      };
    } finally {
      completed++;
      updateProgress();
    }

    const nextIndex = startIndex + CONCURRENCY_LIMIT;
    if (nextIndex < tickets.length) {
      await processBatch(nextIndex);
    }
  }

  const workers = [];
  for (let i = 0; i < CONCURRENCY_LIMIT && i < tickets.length; i++) {
    workers.push(processBatch(i));
  }

  await Promise.all(workers);

  progressBar.classList.remove('progress-bar-animated');
  progressBar.classList.add('bg-success');
  progressBar.textContent = '100%';
  progressText.innerHTML = `✅ Completed processing all ${bulkResults.length} tickets.`;

  downloadBtn.classList.remove('d-none');
}

function downloadCSV() {
  if (bulkResults.length === 0) return;

  const headers = [
    'ticket_id',
    'short_description',
    'long_description',
    'service_tower',
    'intent',
    'intent_description',
    'proposed_solution',
    'summary'
  ];

  const csvContent =
    headers.join(',') + '\n' +
    bulkResults.map(row =>
      headers.map(h => `"${(row[h] || '').replace(/"/g, '""')}"`).join(',')
    ).join('\n');

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ticket_predictions.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
